<!DOCTYPE html>
<html
        xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{main-layout/layout}" lang="es">

<body>

<head>
    <title layout:fragment="pageTitle">gRPC Java Lab - Gestionar Comunidad</title>
</head>

<!-- Contenido que se inyectará en layout.html -->
<div layout:fragment="content"
     data-hx-on:htmx:after-swap="hideLoading()"
     data-hx-on:htmx:response-error="hideLoading()"
     data-hx-on:htmx:send-error="hideLoading()" >

    <!-- Page Heading -->
    <h1 class="h3 mb-2 text-gray-800">Gestionar Comunidades</h1>
    <p class="mb-4">Aqui puede gestionar las comunidades del sistema.</p>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Comunidades</h6>
        </div>
        <div class="card-body" id="filterAndTable" th:fragment="filterAndTable" >
            <!-- El form envía filtros + paginación por POST -->
            <form th:object="${form}"
                  data-hx-post="@{/comunidad/buscar}"
                  data-hx-target="'#filterAndTable'"
                  data-hx-swap="outerHTML"
                  data-hx-on:htmx:before-request="showLoading()" >

                <input type="hidden" th:field="*{paginated.pageSize}"/>
                <input type="hidden" th:field="*{paginated.totalPages}"/>
                <input type="hidden" th:field="*{verFiltros}" />

                <!-- Filtros -->
                <div class="row">
                    <div class="pl-3 mb-3">
                        <a href="javascript:void(0)"
                           data-target="#filtrosWrapper"
                           data-toggle="collapse"
                           th:aria-expanded="*{verFiltros} ? 'true' : 'false'"
                           th:classappend="*{!verFiltros} ? ' collapsed'"
                           aria-controls="filtrosWrapper">
                            <i class="fa fa-filter mr-1"></i>Filtros
                        </a>
                    </div>
                </div>

                <div id="filtrosWrapper" class="row collapse"
                     th:classappend="*{verFiltros} ? ' show'"
                     th:fragment="filter">
                    <div class="pl-3 pr-3 mb-5 w-100 small">
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="filtroId">Id Comunidad</label>
                                <input type="text" name="id" class="form-control" id="filtroId" th:value="*{id}">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="filtroNombre">Nombre Comunidad</label>
                                <input type="text" name="nombre" class="form-control" id="filtroNombre"
                                       th:value="*{nombre}">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group col-md-12">
                                <label for="filtroDireccion">Dirección</label>
                                <input type="text" name="direccion" class="form-control" id="filtroDireccion"
                                       th:value="*{direccion}">
                            </div>

                            <div class="form-group col-md-4">
                                <label for="filtroRegion">Región</label>
                                <select id="filtroRegion" name="regionId" class="form-control" th:value="*{regionId}">
                                    <option value="">Choose...</option>
                                    <!-- opciones -->
                                </select>
                            </div>

                            <div class="form-group col-md-4">
                                <label for="filtroProvincia">Provincia</label>
                                <select id="filtroProvincia" name="provinciaId" class="form-control"
                                        th:value="*{provinciaId}">
                                    <option value="">Choose...</option>
                                    <!-- opciones -->
                                </select>
                            </div>

                            <div class="form-group col-md-4">
                                <label for="filtroComuna">Comuna</label>
                                <select id="filtroComuna" name="comunaId" class="form-control" th:value="*{comunaId}">
                                    <option value="">Choose...</option>
                                    <!-- opciones -->
                                </select>
                            </div>
                        </div>

                        <!-- Botón de aplicar filtros (POST) -->
                        <button id="btnLimpiarFiltros" type="button" class="btn btn-link">Limpiar Filtros</button>
                    </div>
                </div>

                <!-- Tabla -->
                <div class="row">
                    <div class="table-responsive pl-3 pr-3" th:fragment="table">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th scope="col">Id</th>
                                <th scope="col">Nombre</th>
                                <th scope="col">Tipo</th>
                                <th scope="col">Dirección</th>
                                <th scope="col">Comuna</th>
                                <th scope="col">Provincia</th>
                                <th scope="col">Region</th>
                                <th scope="col">Acciones</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="comunidad : ${comunidades}" th:data-id-comunidad="${comunidad.id}">
                                <th scope="row" th:text="${comunidad.idAbreviado}" th:title="${comunidad.id}"></th>
                                <td th:text="${comunidad.nombre}"></td>
                                <td th:text="${comunidad.tipoNombre}"></td>
                                <td th:text="${comunidad.direccion}"></td>
                                <td th:text="${comunidad.comunaNombre}"></td>
                                <td th:text="${comunidad.provinciaNombre}"></td>
                                <td th:text="${comunidad.regionNombre}"></td>
                                <td></td>
                            </tr>
                            <tr th:if="${comunidades == null or comunidades.empty}" >
                                <td colspan="8" style="text-align: center;">No se encontraron comunidades</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Paginación -->
                <div class="row" th:if="${form.paginated.totalPages > 1}">
                    <div class="col-auto ml-auto pr-3">
                        <nav>
                            <ul class="pagination">

                                <!-- Botón anterior -->
                                <li class="page-item"
                                    th:classappend="${form.paginated.pageNumber == 0} ? ' disabled'">
                                    <button type="submit"
                                            class="page-link btn btn-link p-0"
                                            name="paginated.pageNumber"
                                            th:value="${form.paginated.pageNumber - 1}"
                                            th:disabled="${form.paginated.pageNumber == 0}">
                                        &laquo;
                                    </button>
                                </li>

                                <!-- Números de página -->
                                <th:block th:with="
                start=${T(java.lang.Math).max(1, form.paginated.pageNumber - 3)},
                end=${T(java.lang.Math).min(form.paginated.totalPages, form.paginated.pageNumber + 3)}">

                                    <li class="page-item"
                                        th:each="p : ${#numbers.sequence(start, end)}"
                                        th:classappend="${p == filtro.paginated.pageNumber + 1} ? ' active'">
                                        <button type="submit"
                                                class="page-link btn btn-link p-0"
                                                name="paginated.pageNumber"
                                                th:value="${p - 1}">
                                            <span th:text="${p}">1</span>
                                        </button>
                                    </li>
                                </th:block>

                                <!-- Botón siguiente -->
                                <li class="page-item"
                                    th:classappend="${(form.paginated.pageNumber + 1) == form.paginated.totalPages} ? ' disabled'">
                                    <button type="submit"
                                            class="page-link btn btn-link p-0"
                                            name="paginated.pageNumber"
                                            th:value="${form.paginated.pageNumber + 1}"
                                            th:disabled="${(form.paginated.pageNumber + 1) == form.paginated.totalPages}">
                                        &raquo;
                                    </button>
                                </li>

                            </ul>
                        </nav>
                    </div>
                </div>

            </form>
        </div>
    </div>

</div>

<th:block layout:fragment="page-js">
    <script type="text/javascript">
        $(function() {
            const DEBOUNCE_MS = 1000;
            const $inputVerFiltros = $('[name="verFiltros"]');
            const $filtrosWrapper = $('#filtrosWrapper');
            let timer = null;


            $filtrosWrapper.on('shown.bs.collapse', function (e) {
                $inputVerFiltros.val('true');
            });

            $filtrosWrapper.on('hidden.bs.collapse', function (e) {
                $inputVerFiltros.val('false');
            });

            function scheduleSubmit() {
              const $form = $('#filterAndTable form');
              if ($form.length === 0) return;

              clearTimeout(timer);
              timer = setTimeout(function () {
                // Dispara un submit "real" para que HTMX lo intercepte
                if ($form[0].requestSubmit) {
                  $form[0].requestSubmit();      // modernos
                } else {
                  $form.trigger('submit');       // fallback
                }
              }, DEBOUNCE_MS);
            }

              // 1) Para inputs de texto/textarea: SOLO 'input' (no 'change')
            $(document).on(
                'input',
                '#filterAndTable input:not([type="hidden"]):not([type="checkbox"]):not([type="radio"]), #filterAndTable textarea',
                scheduleSubmit
            );

            // 2) Para selects/checkbox/radio: SOLO 'change'
            $(document).on(
                'change',
                '#filterAndTable select, #filterAndTable input[type="checkbox"], #filterAndTable input[type="radio"]',
                scheduleSubmit
            );

            // Si se hace submit manual (botón), cancela cualquier submit pendiente
            $(document).on('submit', '#filterAndTable form', function () {
              clearTimeout(timer);
            });

            // Si HTMX va a reemplazar el bloque, evita doble submit
            document.body.addEventListener('htmx:beforeSwap', function (evt) {
              if (evt.target && evt.target.id === 'filterAndTable') {
                clearTimeout(timer);
              }
            });

            $(document).on('click', '#btnLimpiarFiltros', function (e) {
              e.preventDefault();
              var $form = $('#filterAndTable form');

              // Limpia textos/números/fechas (excepto hidden, submit, etc.)
              $form.find('input:not([type="hidden"]):not([type="submit"]):not([type="button"]):not([type="reset"])').val('');
              $form.find('textarea').val('');

              // Limpia selects (apunta al placeholder con value="")
              $form.find('select').each(function () {
                if ($(this).find('option[value=""]').length) {
                  $(this).val('');
                } else {
                  this.selectedIndex = 0; // fallback
                }
                $(this).trigger('change'); // por si hay dependencias
              });

              // Limpia checks/radios
              $form.find('input[type="checkbox"], input[type="radio"]').prop('checked', false);

              // Reinicia la página a la primera (0)
              var $pageNumber = $form.find('input[name="paginated.pageNumber"]');
              if ($pageNumber.length === 0) {
                $('<input type="hidden" name="paginated.pageNumber" value="0">').appendTo($form);
              } else {
                $pageNumber.val('0');
              }

              // Envía con HTMX
              if ($form[0].requestSubmit) $form[0].requestSubmit(); else $form.trigger('submit');
            });

        });
    </script>
</th:block>

</body>
</html>